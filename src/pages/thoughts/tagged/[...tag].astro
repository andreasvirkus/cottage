---
import { type CollectionEntry, getCollection } from 'astro:content'

import PostFeed from '../../../components/PostFeed.astro';
import { getConicGradient } from '../../../utils/conic-art'

type Props = CollectionEntry<'thoughts'>

export async function getStaticPaths() {
  const allPosts = await getCollection('thoughts')
  const uniqueTags = [...new Set(allPosts.map((post: any) => post.data.tags).flat())];

  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post: any) => post.data.tags?.includes(tag));
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

// TODO: We should unify this with code in thoughts/index.astro to avoid duplication?
const { tag } = Astro.params;

const tags = new Set<string>()
let posts = ((await getCollection('thoughts')) || [])
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map((post) => {
    post.data.tags?.forEach((tag: string) => tags.add(tag))
    return {
      ...post,
      data: {
        ...post.data,
        heroImage: getConicGradient(post.slug || ''),
      },
    }
  })
  .filter((post) => post.data.tags?.includes(tag))
---

<PostFeed posts={posts} tags={Array.from(tags)} />

<style>

.tags {
  position: relative;
  display: flex;
  flex-wrap: wrap;
  column-gap: 1.5em;
  row-gap: 0.5em;
  margin-bottom: 2em;
  overflow: hidden; /* Hide seperators when wrapping */
}

.tag::before {
  content: '*';
  position: absolute;
  translate: -1.1em 0;
}
</style>

